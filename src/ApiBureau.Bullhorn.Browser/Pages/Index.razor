@page "/"
@using CodeCapital.System.Text.Json;
@using System.Text;

<PageTitle>Bullhorn API Browser</PageTitle>

<div class="row">
    <div class="col-md-12 col-lg-6">
        <div class="mb-3">
            <label for="exampleFormControlTextarea1" class="form-label"></label>
            <InputRadioGroup Value="_selectedType" Name="filter" TValue="string" ValueExpression="() => _selectedType" ValueChanged="(e) => SetType(e)">
                @foreach (var item in _types)
                {
                    <div class="form-check form-check-inline">
                        <InputRadio Name="filter" Value="@item" id="@($"radio-{item}")" class="form-check-input action" />
                        <label class="form-check-label action" for="@($"radio-{item}")">@item</label>
                    </div>
                }
            </InputRadioGroup>
            <InputTextArea @bind-Value="_query" rows="5" class="form-control mt-3" id="exampleFormControlTextarea1" />
            <button class="btn btn-primary mt-3" @onclick="SubmitAsync">
                @if (_isLoading)
                {
                    <i class="fa-solid fa-spinner fa-spin-pulse me-2"></i>
                }
                Submit
            </button>

            <button class="btn btn-secondary" @onclick="GetData">Get Data</button>
        </div>
    </div>
    <div class="col-md-12 col-lg-6" style="overflow-wrap: anywhere">
        <p>Response:</p>
        @_response
    </div>
    <div class="col-12">
        @_resultDynanmic
        @_resultJson
    </div>
    <div class="col-12">
        <table class="table table-sm">
            <thead>
                <tr>
                    @foreach (var item in _columnNames)
                    {
                        <th>@item</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var row in _data)
                {
                    <tr>
                        @foreach (var header in _columnNames)
                        {
                            <td>@JsonTableHelper.GetValueAsString(row, header)</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<SurveyPrompt Title="How is Blazor working for you?" />

@code {
    [Inject] protected DataService DataService { get; set; } = default!;

    private bool _isLoading = false;
    private string _query = "CorporationDepartment?fields=id,dateAdded,name,enabled&where=id>0&orderBy=enabled,dateAdded";
    private string _selectedType = "query";
    private string _response = "";
    private string _resultJson = "";
    private string _resultDynanmic = "";
    private List<string> _types = new List<string> { "query", "search", "entity", "any" };
    private List<IDictionary<string, object>> _data = new();
    private HashSet<string> _columnNames = new();

    private void SetType(string value)
    {
        _selectedType = value;
    }

    private async Task SubmitAsync()
    {
        _isLoading = true;

        _response += _query;

        var response = await DataService.ApiCallToDynamicAsync($"{_selectedType}/{_query}", 100, 0);

        _response = response.RequestUri + _response;

        _resultJson = response.Json;
        _resultDynanmic = response.DynamicData.ToString();

        _isLoading = false;
    }

    private async Task GetData()
    {
        var flattener = new JsonFlattener();
        var options = new JsonSerializerFlattenOptions { KeyDelimiter = " " };

        //_data = await Task.Run(() => flattener.Flatten(GetJsonSample(), options));

        var response = await DataService.ApiCallToDynamicAsync($"{_selectedType}/{_query}", 100, 0);

        _data = await flattener.FlattenAsync(new MemoryStream(Encoding.UTF8.GetBytes(response.Json)), options);
        //_data = await flattener.FlattenAsync(new MemoryStream(Encoding.UTF8.GetBytes(GetJsonSample())), options);

        _columnNames = JsonTableHelper.ExtractColumnNames(_data);
    }

    private string GetJsonSample()
    {
        return
     """"
[{"id":12647,"dateAdded":1322826368183,"name":"FS Tech","enabled":true},{"id":12648,"dateAdded":1322826368213,"name":"FS Finance","enabled":true},{"id":12649,"dateAdded":1322826368213,"name":"C & I Tech","enabled":true},{"id":12650,"dateAdded":1322826368230,"name":"C & I Finance","enabled":true},{"id":12651,"dateAdded":1322826368230,"name":"Prof Serv","enabled":true},{"id":12652,"dateAdded":1322826368260,"name":"Lothbury","enabled":true},{"id":12653,"dateAdded":1322826368277,"name":"US FS","enabled":true},{"id":12654,"dateAdded":1322826368290,"name":"US C & I","enabled":true},{"id":12655,"dateAdded":1322826368307,"name":"Mission Control","enabled":true},{"id":13504,"dateAdded":1332243903857,"name":"Twenty Recruitment","enabled":true},{"id":13566,"dateAdded":1333361273607,"name":"IT","enabled":true},{"id":15424,"dateAdded":1349771399330,"name":"Twenty Smoke Test","enabled":true},{"id":17252,"dateAdded":1364234627347,"name":"FS Operations","enabled":true},{"id":19663,"dateAdded":1386841255297,"name":"Energy","enabled":true},{"id":19664,"dateAdded":1386841255330,"name":"Health","enabled":true},{"id":19665,"dateAdded":1386841255343,"name":"Digital","enabled":true},{"id":21565,"dateAdded":1400507193687,"name":"FS Compliance","enabled":true, "age": 23}]
"""";
    }
}